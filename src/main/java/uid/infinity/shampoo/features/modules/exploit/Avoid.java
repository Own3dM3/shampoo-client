package uid.infinity.shampoo.features.modules.exploit;

import uid.infinity.shampoo.features.modules.Module;
import uid.infinity.shampoo.features.settings.Setting;
import net.fabricmc.fabric.api.client.event.lifecycle.v1.ClientTickEvents;
import net.minecraft.block.Block;
import net.minecraft.block.Blocks;
import net.minecraft.client.MinecraftClient;
import net.minecraft.client.network.ClientPlayerEntity;
import net.minecraft.util.math.BlockPos;
import net.minecraft.util.math.Vec3d;

public class Avoid extends Module {

    private final Setting<Boolean> voidAvoid = register(new Setting<>("Void", true));
    private final Setting<Boolean> fireAvoid = register(new Setting<>("Fire", false));
    private final Setting<Boolean> berryBushAvoid = register(new Setting<>("BerryBush", false));
    private final Setting<Boolean> cactusAvoid = register(new Setting<>("Cactus", false));
    private final Setting<Boolean> unloadedChunkAvoid = register(new Setting<>("Unloaded", false));

    private static final MinecraftClient mc = MinecraftClient.getInstance();

    public Avoid() {
        super("Avoid", "Prevents player from entering harmful areas", Category.EXPLOIT, true, false, false);
    }

    @Override
    public void onEnable() {
        ClientTickEvents.END_CLIENT_TICK.register(client -> {
            if (client.player == null || client.world == null) return;
            if (!this.isEnabled()) return;

            ClientPlayerEntity player = client.player;
            Vec3d pos = player.getPos();

            if (voidAvoid.getValue() && !player.isSpectator() && pos.y < client.world.getBottomY()) {
                player.setVelocity(player.getVelocity().x, 0.0, player.getVelocity().z);
                player.fallDistance = 0.0f;
            }
            BlockPos playerBlockPos = player.getBlockPos();
            BlockPos feetPos = playerBlockPos.down();

            for (int x = -1; x <= 1; x++) {
                for (int z = -1; z <= 1; z++) {
                    BlockPos checkPos = feetPos.add(x, 0, z);
                    Block block = client.world.getBlockState(checkPos).getBlock();

                    if (isDangerousBlock(block, checkPos)) {

                        double dx = checkPos.getX() + 0.5 - pos.x;
                        double dz = checkPos.getZ() + 0.5 - pos.z;
                        double distSq = dx * dx + dz * dz;

                        if (distSq < 2.0) {
                            Vec3d motion = player.getVelocity();
                            player.setVelocity(0, motion.y, 0);
                        }
                    }
                }
            }
        });
    }

    private boolean isDangerousBlock(Block block, BlockPos pos) {
        if (fireAvoid.getValue() && block == Blocks.FIRE) {
            return true;
        }
        if (cactusAvoid.getValue() && block == Blocks.CACTUS) {
            return true;
        }
        if (berryBushAvoid.getValue() && block == Blocks.SWEET_BERRY_BUSH) {
            return true;
        }
        if (unloadedChunkAvoid.getValue()) {
            if (!mc.world.isChunkLoaded(pos.getX() >> 4, pos.getZ() >> 4)) {
                return true;
            }
        }
        return false;
    }
}